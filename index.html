<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Olympic Host Cities Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    html,body,#map { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    #controls {
      position: absolute; top: 10px; left: 10px; z-index: 1000;
      background: rgba(255,255,255,0.95); padding: 8px; border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    #credits { position: absolute; right: 10px; bottom: 10px; z-index:1000; background: rgba(255,255,255,0.85); padding:6px; border-radius:6px; font-size:12px }
    select, button { font-size: 14px; }
    /* Dark mode styles applied to body.dark */
    body.dark { background: #0b0f13; color: #e6eef6; }
    body.dark #controls { background: rgba(20,24,28,0.95); color: #e6eef6; }
    body.dark #controls button, body.dark #controls input, body.dark #controls select { background: #111417; color: #e6eef6; border-color: rgba(255,255,255,0.06); }
    body.dark #timeline { background: rgba(8,10,12,0.9); }
    body.dark #credits { background: rgba(8,10,12,0.85); color: #cfdff4; }
  </style>
</head>
<body>
  <div id="controls">
    <label for="yearSelect"><strong>Year:</strong></label>
    <select id="yearSelect"><option value="all">All</option></select>
    <input id="searchBox" placeholder="Search city or country" style="margin-left:8px; padding:4px 6px;" />
    <button id="searchBtn">Search</button>
    <button id="resetBtn">Reset</button>
    <button id="darkToggle" style="margin-left:8px;">Dark Mode</button>
  </div>

  <div id="map"></div>
  <div id="credits">Map: <a href="https://leafletjs.com" target="_blank" rel="noopener">Leaflet</a> • Data: `data/geocoded_hosts.json`</div>
  <div id="timeline" style="position: absolute; left: 0; right:0; bottom: 0; z-index:1000; display:flex; gap:6px; padding:8px; overflow:auto; background: rgba(255,255,255,0.9);"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
    const MAP_DIV_ID = 'map';
    const DATA_PATH = 'data/geocoded_hosts.json';

    // guard: ensure Leaflet loaded
    if (typeof L === 'undefined') {
      document.body.innerHTML = '<div style="padding:24px;font-family:system-ui,Arial;">Error: Leaflet failed to load. Check browser console and network.\n<br/>If you used a local server, ensure external CDN requests are allowed.</div>';
      throw new Error('Leaflet not loaded');
    }

    // init map with light/dark base layers
    const map = L.map(MAP_DIV_ID).setView([20, 0], 2);
    const lightTiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    });
    const darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors &  &copy; CARTO'
    });

    let currentBase = null;
    function setDarkMode(enabled) {
      const body = document.body;
      if (enabled) {
        body.classList.add('dark');
        if (currentBase) map.removeLayer(currentBase);
        currentBase = darkTiles;
        currentBase.addTo(map);
        document.getElementById('darkToggle').textContent = 'Light Mode';
      } else {
        body.classList.remove('dark');
        if (currentBase) map.removeLayer(currentBase);
        currentBase = lightTiles;
        currentBase.addTo(map);
        document.getElementById('darkToggle').textContent = 'Dark Mode';
      }
      try { localStorage.setItem('darkMode', enabled ? '1' : '0'); } catch (e){}
    }

    // initialize base layer from preference
    const saved = (function(){ try { return localStorage.getItem('darkMode'); } catch(e){ return null; }})();
    const startDark = saved === '1' || (saved === null && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
    setDarkMode(Boolean(startDark));

    // wire dark toggle button
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('darkToggle');
      if (btn) btn.addEventListener('click', () => setDarkMode(!document.body.classList.contains('dark')));
    });

    // helpers
    function makeMarker(item) {
      const lat = parseFloat(item.lat);
      const lon = parseFloat(item.lon);
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) return null;
      const marker = L.marker([lat, lon]);
      const title = `${item.year} — ${item.city}, ${item.country}`;
      const popup = `<strong>${item.city}, ${item.country}</strong><br/>Year: ${item.year}`;
      marker.bindPopup(popup);
      marker.bindTooltip(title, {direction: 'top', offset: [0, -8]});
      marker._meta = { year: item.year, city: item.city, country: item.country, key: item.key };
      return marker;
    }

    async function loadAndRender() {
      const res = await fetch(DATA_PATH);
      const data = await res.json();

        // convert object to array of items
        // Exclude cancelled Olympic years from the display
        const canceledYears = new Set(['1916', '1940', '1944']);
        const items = Object.keys(data).map(k => data[k]).filter(it => it && it.status === 'ok' && !canceledYears.has(String(it.year)));

      // build year index (include cancelled years for bookkeeping)
      const yearsActive = [...new Set(items.map(i => i.year).filter(Boolean))].map(String);
      const yearsAllSet = new Set(yearsActive);
      Array.from(canceledYears).forEach(y => yearsAllSet.add(String(y)));
      const years = Array.from(yearsAllSet).sort((a,b)=>parseInt(a)-parseInt(b));
      const select = document.getElementById('yearSelect');
      // show which years are cancelled
      const controls = document.getElementById('controls');
      const note = document.createElement('div');
      note.id = 'cancelNote';
      note.style.fontSize = '12px'; note.style.marginTop = '6px'; note.style.color = '#444';
      note.textContent = 'Cancelled years (bookkeeping): ' + Array.from(canceledYears).sort().join(', ');
      controls.appendChild(note);
      years.forEach(y => { const opt = document.createElement('option'); opt.value = y; opt.textContent = y; select.appendChild(opt); });

      // create markers and indexes
      const markersByYear = {};
      const allMarkers = [];
      const searchIndex = [];
      items.forEach(it => {
        const m = makeMarker(it);
        if (!m) return;
        const year = it.year || 'unknown';
        markersByYear[year] = markersByYear[year] || [];
        markersByYear[year].push(m);
        allMarkers.push(m);
        // build search tokens
        const token = `${(it.city||'').toLowerCase()} ${(it.country||'').toLowerCase()}`.trim();
        searchIndex.push({ token, marker: m, item: it });
      });

      // create clusters
      let currentCluster = L.markerClusterGroup();
      currentCluster.addLayers(allMarkers);
      map.addLayer(currentCluster);

      // fit to bounds
      if (allMarkers.length) {
        const group = L.featureGroup(allMarkers);
        map.fitBounds(group.getBounds().pad(0.1));
      }

      // timeline: render year chips
      const timeline = document.getElementById('timeline');
      years.forEach(y => {
        const btn = document.createElement('button');
        const isCancelled = canceledYears.has(String(y));
        btn.textContent = isCancelled ? `${y} (Cancelled)` : y;
        btn.style.padding = '6px 8px'; btn.style.fontSize = '13px'; btn.style.borderRadius = '4px'; btn.style.border = '1px solid rgba(0,0,0,0.08)';
        btn.style.background = isCancelled ? '#f3f3f3' : '#fff';
        btn.style.color = isCancelled ? '#666' : '#000';
        btn.addEventListener('click', () => { select.value = y; select.dispatchEvent(new Event('change')); });
        timeline.appendChild(btn);
      });

      // search
      const searchBox = document.getElementById('searchBox');
      const searchBtn = document.getElementById('searchBtn');
      function doSearch() {
        const q = (searchBox.value || '').toLowerCase().trim();
        if (!q) return;
        // simple substring match; prefer exact city+country
        let best = null;
        for (const s of searchIndex) {
          if (s.token === q) { best = s; break; }
          if (s.token.includes(q)) { best = best || s; }
        }
        if (!best) {
          // try matches on city only
          for (const s of searchIndex) {
            if ((s.item.city||'').toLowerCase() === q) { best = s; break; }
            if ((s.item.city||'').toLowerCase().includes(q)) best = best || s;
          }
        }
        if (best) {
          const m = best.marker;
          map.setView(m.getLatLng(), 8);
          m.openPopup();
        } else {
          alert('No match found for: ' + searchBox.value);
        }
      }
      searchBtn.addEventListener('click', doSearch);
      searchBox.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') doSearch(); });

      // handle year filter
      select.addEventListener('change', () => {
        const val = select.value;
        // clear any status message
        const statusElId = 'statusMessage';
        let statusEl = document.getElementById(statusElId);
        if (statusEl) statusEl.remove();

        if (currentCluster) map.removeLayer(currentCluster);
        currentCluster = L.markerClusterGroup();
        if (val === 'all') {
          currentCluster.addLayers(allMarkers);
          map.addLayer(currentCluster);
          if (allMarkers.length) map.fitBounds(L.featureGroup(allMarkers).getBounds().pad(0.1));
        } else if (canceledYears.has(String(val))) {
          // cancelled year: show no markers but display bookkeeping message
          map.addLayer(currentCluster); // empty
          statusEl = document.createElement('div');
          statusEl.id = statusElId;
          statusEl.style.marginTop = '6px'; statusEl.style.fontSize = '13px'; statusEl.style.color = '#a00';
          statusEl.textContent = `Year ${val} was cancelled — no host locations are shown.`;
          controls.appendChild(statusEl);
        } else {
          const markers = markersByYear[val] || [];
          currentCluster.addLayers(markers);
          map.addLayer(currentCluster);
          if (markers.length) map.fitBounds(L.featureGroup(markers).getBounds().pad(0.1));
        }
      });

      document.getElementById('resetBtn').addEventListener('click', () => {
        select.value = 'all';
        searchBox.value = '';
        if (currentCluster) map.removeLayer(currentCluster);
        currentCluster = L.markerClusterGroup();
        currentCluster.addLayers(allMarkers);
        map.addLayer(currentCluster);
        if (allMarkers.length) map.fitBounds(L.featureGroup(allMarkers).getBounds().pad(0.1));
      });
    }

    loadAndRender().catch(err => {
      console.error(err);
      const el = document.createElement('div'); el.style.padding = '12px'; el.style.background = 'white'; el.textContent = 'Failed to load geocoded data.'; document.body.appendChild(el);
    });
  </script>
</body>
</html>
